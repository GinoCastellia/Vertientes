<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComitéActivo: Gestión para Edificios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- LeafletJS for Interactive Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- LeafletJS Draw Plugin for drawing zones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <style>
        :root {
            --bg-light: #f3e8ff; --bg-dark: #1e1b4b;
            --sidebar-light: #1e1b4b; --sidebar-dark: #0c0a1d;
            --card-light-bg: rgba(255, 255, 255, 0.8);
            --card-dark-bg: rgba(55, 48, 163, 0.5);
            --text-light: #1e1b4b; --text-dark: #e0e7ff;
            --text-muted-light: #4c1d95; --text-muted-dark: #a5b4fc;
            --border-light: rgba(226, 232, 240, 0.9);
            --border-dark: rgba(129, 140, 248, 0.3);
            --primary: #6d28d9; --primary-hover: #5b21b6;
        }
        html.dark { color-scheme: dark; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9;
            color: var(--text-light);
            overflow: hidden;
        }
        html.dark body { 
            background-color: #0f172a;
            color: var(--text-dark); 
        }
        #app-wrapper {
            background-color: var(--bg-light);
            background-image: linear-gradient(135deg, #f3e8ff 0%, #e0e7ff 100%);
        }
        html.dark #app-wrapper {
            background-color: var(--bg-dark); 
            background-image: linear-gradient(135deg, #1e1b4b 0%, #0c0a1d 100%);
        }
        .sidebar { transition: transform 0.3s ease-in-out; background-color: var(--sidebar-light); }
        html.dark .sidebar { background-color: var(--sidebar-dark); }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .modal-backdrop { background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(8px); z-index: 40; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        .card { 
            background-color: var(--card-light-bg); 
            border: 1px solid var(--border-light); 
            backdrop-filter: blur(12px);
            border-radius: 1.5rem; 
        }
        html.dark .card { 
            background-color: var(--card-dark-bg); 
            border-color: var(--border-dark); 
        }
        .sidebar .nav-link { color: #c7d2fe; font-weight: 500; }
        .sidebar .nav-link:hover { background-color: rgba(79, 70, 229, 0.5); color: #ffffff; }
        .sidebar .nav-link.active { 
            color: #ffffff;
            background-color: #4f46e5;
            font-weight: 700;
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39);
        }
        .btn-primary {
            background-color: var(--primary); color: white; transition: all 0.3s ease; border-radius: 0.75rem;
            box-shadow: 0 4px 15px -5px rgba(109, 40, 217, 0.6);
        }
        .btn-primary:hover { 
            background-color: var(--primary-hover); transform: translateY(-2px); 
            box-shadow: 0 6px 20px -5px rgba(109, 40, 217, 0.8);
        }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; transform: none; box-shadow: none;}
        .form-input {
            background-color: #f8fafc !important; color: #0f172a !important; border: 1px solid #e2e8f0;
            border-radius: 0.75rem; transition: all 0.3s ease;
        }
        .form-input:focus {
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.2);
        }
        html.dark .form-input {
            background-color: #1e293b !important; color: #e2e8f0 !important; border-color: #334155;
        }
        html.dark .form-input:focus { box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.3); }
        #leaflet-map { width: 100%; height: 75vh; border-radius: 1.5rem; z-index: 10; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800">
    <!-- Login Screen -->
    <div id="login-screen" class="h-screen w-screen flex items-center justify-center">
        <div class="w-full h-full flex items-center justify-center shadow-2xl">
            <!-- Left Panel -->
            <div class="hidden lg:flex w-1/2 h-full bg-indigo-700 items-center justify-center relative overflow-hidden">
                <div class="absolute w-60 h-60 rounded-xl bg-indigo-800 -top-5 -left-16 transform rotate-45 opacity-50"></div>
                <div class="absolute w-72 h-72 rounded-full bg-indigo-600 -bottom-24 -right-8 opacity-50"></div>
                <div class="z-10 text-white text-center p-12">
                    <svg class="h-20 w-20 mx-auto mb-6 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 20V10H10V20H14Z" fill="currentColor" opacity="0.7"/><path d="M20 20V4H16V20H20Z" fill="currentColor"/><path d="M4 20V14H8V20H4Z" fill="currentColor" opacity="0.7"/></svg>
                    <h1 class="text-5xl font-bold mb-3 tracking-tight">ComitéActivo</h1>
                    <p class="text-indigo-200 text-lg">Gestión inteligente para tu comunidad.</p>
                </div>
            </div>
            <!-- Right Panel -->
            <div class="w-full lg:w-1/2 h-full flex items-center justify-center bg-white dark:bg-slate-900">
                <div class="w-full max-w-sm p-8">
                    <h2 id="auth-title" class="text-3xl font-bold text-gray-800 dark:text-white mb-2">Bienvenido</h2>
                    <p id="auth-subtitle" class="text-gray-500 dark:text-gray-400 mb-8">Ingresa tus credenciales para continuar.</p>
                    <form id="login-form" class="space-y-6">
                        <div class="relative"><i class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="email" id="login-email" class="form-input mt-1 block w-full pl-12 p-3.5" placeholder="Email" required></div>
                        <div class="relative"><i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="password" id="login-password" class="form-input mt-1 block w-full pl-12 p-3.5" placeholder="Contraseña" required></div>
                        <p id="auth-error" class="text-red-500 text-sm text-center hidden"></p>
                        <button type="submit" class="btn-primary w-full py-3 font-bold text-lg">Ingresar</button>
                    </form>
                    <form id="register-form" class="space-y-6 hidden">
                        <div class="relative"><i class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="email" id="register-email" class="form-input mt-1 block w-full pl-12 p-3.5" placeholder="Email" required></div>
                        <div class="relative"><i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="password" id="register-password" class="form-input mt-1 block w-full pl-12 p-3.5" placeholder="Contraseña (mín. 6 caracteres)" required></div>
                        <button type="submit" class="btn-primary w-full py-3 font-bold text-lg">Crear Cuenta</button>
                    </form>
                    <p id="config-prompt" class="text-center mt-4 text-sm text-orange-600 dark:text-orange-400 font-semibold hidden"><i class="fas fa-exclamation-triangle mr-2"></i>La aplicación no está configurada.</p>
                    <p class="text-center mt-6 text-sm text-gray-500 dark:text-gray-400">
                        <span id="login-prompt">¿No tienes una cuenta? <a href="#" id="show-register" class="font-semibold text-indigo-600 hover:underline dark:text-indigo-400">Regístrate</a></span>
                        <span id="register-prompt" class="hidden">¿Ya tienes una cuenta? <a href="#" id="show-login" class="font-semibold text-indigo-600 hover:underline dark:text-indigo-400">Inicia Sesión</a></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Wrapper -->
    <div id="app-wrapper" class="hidden h-screen">
        <div id="app-container" class="flex h-full overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar w-64 min-h-full p-4 flex-shrink-0 transform -translate-x-full md:translate-x-0 md:relative">
                <div class="flex items-center gap-3 mb-10 px-1">
                    <div class="bg-white/10 p-2 rounded-xl"><svg class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 20V10H10V20H14Z" fill="currentColor" opacity="0.7"/><path d="M20 20V4H16V20H20Z" fill="currentColor"/><path d="M4 20V14H8V20H4Z" fill="currentColor" opacity="0.7"/></svg></div>
                    <div><h1 class="text-xl font-bold text-white">ComitéActivo</h1><p id="userIdDisplay" class="text-xs text-indigo-300">Cargando...</p></div>
                </div>
                <nav>
                    <a href="#dashboard" class="nav-link active flex items-center p-3 rounded-xl" data-module="dashboard"><i class="fas fa-home w-6 text-center"></i><span class="ml-4">Dashboard</span></a>
                    <a href="#mantencion" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="mantencion"><i class="fas fa-tools w-6 text-center"></i><span class="ml-4">Mantención</span></a>
                    <a href="#tareas" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="tareas"><i class="fas fa-tasks w-6 text-center"></i><span class="ml-4">Tareas</span></a>
                    <a href="#jardineria" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="jardineria"><i class="fas fa-seedling w-6 text-center"></i><span class="ml-4">Jardinería</span></a>
                    <a href="#inventario" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="inventario"><i class="fas fa-box-open w-6 text-center"></i><span class="ml-4">Inventario</span></a>
                    <a href="#proveedores" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="proveedores"><i class="fas fa-truck w-6 text-center"></i><span class="ml-4">Proveedores</span></a>
                    <a href="#directorio" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="directorio"><i class="fas fa-address-book w-6 text-center"></i><span class="ml-4">Directorio</span></a>
                    <a href="#admin" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="admin"><i class="fas fa-user-shield w-6 text-center"></i><span class="ml-4">Administración</span></a>
                </nav>
                <div class="absolute bottom-4 left-4 right-4">
                     <button id="logout-btn" class="w-full flex items-center justify-center gap-2 p-3 mb-2 rounded-xl text-indigo-200 hover:bg-red-800/50"><i class="fas fa-sign-out-alt text-xl"></i><span>Cerrar Sesión</span></button>
                     <button id="theme-toggle" class="w-full flex items-center justify-center gap-2 p-3 rounded-xl text-indigo-200 hover:bg-indigo-800"><i class="fas fa-moon text-xl"></i><span>Modo Oscuro</span></button>
                </div>
            </aside>

            <!-- Main Content -->
            <div id="main-content" class="main-content flex-1 flex flex-col overflow-hidden">
                <header class="p-6 flex justify-between items-center"><button id="open-sidebar-btn" class="md:hidden text-indigo-900 dark:text-indigo-200"><i class="fas fa-bars text-xl"></i></button><div><h2 id="page-title" class="text-2xl font-bold text-indigo-900 dark:text-white">Dashboard</h2></div><div class="text-right"><p id="current-date" class="font-semibold text-indigo-900 dark:text-white"></p><p class="text-sm text-muted-light dark:text-muted-dark">¡Bienvenido de nuevo!</p></div></header>
                <main class="flex-1 overflow-x-hidden overflow-y-auto p-6 pt-0">
                    <div id="dashboard" class="page active"></div>
                    <div id="mantencion" class="page"></div>
                    <div id="tareas" class="page"></div>
                    <div id="jardineria" class="page"></div>
                    <div id="inventario" class="page"></div>
                    <div id="proveedores" class="page"></div>
                    <div id="directorio" class="page"></div>
                    <div id="admin" class="page"></div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="confirmationModal" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden"><div class="card w-11/12 md:w-1/3 p-6"><h3 class="text-xl font-semibold mb-4">Confirmación Requerida</h3><p id="confirmation-message" class="mb-6"></p><div class="flex justify-end gap-4"><button id="cancel-confirmation-btn" class="bg-gray-200 dark:bg-gray-600 p-2 rounded-lg">Cancelar</button><button id="confirm-action-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button></div></div></div>
    <div id="user-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden"><div class="card w-11/12 md:w-1/3 p-6"><h3 id="user-modal-title" class="text-xl font-semibold mb-4">Crear Nuevo Usuario</h3><form id="user-form" class="space-y-4"><div><label>Email del usuario</label><input type="email" id="user-email" class="form-input w-full" required></div><div><label>Contraseña Inicial</label><input type="password" id="user-password" class="form-input w-full" required></div><div><label>Asignar Rol</label><select id="user-role" class="form-input w-full"><option value="jardineria">Jardinería</option><option value="mayordomo">Mayordomo</option><option value="comite">Comité</option><option value="administrador_condominio">Administrador de Condominio</option></select></div><p id="user-form-error" class="text-red-500 text-sm hidden"></p><div class="flex justify-end gap-4"><button type="button" onclick="hideModal('user-modal')" class="bg-gray-200 dark:bg-gray-600 p-2 rounded-lg">Cancelar</button><button type="submit" class="btn-primary p-2">Crear Usuario</button></div></form></div></div>
    <div id="custom-alert" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50"><p id="custom-alert-message"></p></div>
    <!-- Generic Modals: Populated by JS -->
    <div id="genericModalContainer"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, deleteDoc, query, where, getDocs, addDoc, updateDoc, serverTimestamp, increment, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth, currentUserRole = null;
        let unsubscribeListeners = [];
        let tasksChart, maintenanceChart;
        let tempApp; // For creating users without signing out the admin
        
        const ADMIN_EMAIL = "admin_gino@comite.cl";
        const loginScreen = document.getElementById('login-screen');
        const appWrapper = document.getElementById('app-wrapper');

        async function initializeFirebase() {
            const storedConfig = localStorage.getItem('firebaseConfig');
            if (storedConfig) {
                try {
                    const firebaseConfig = JSON.parse(storedConfig);
                    const mainApp = initializeApp(firebaseConfig);
                    tempApp = initializeApp(firebaseConfig, "secondary");
                    db = getFirestore(mainApp);
                    auth = getAuth(mainApp);
                    // Enable offline persistence
                    await enableIndexedDbPersistence(db);
                    return true;
                } catch (e) {
                    if (e.code === 'failed-precondition') {
                        // This happens if persistence is enabled in multiple tabs.
                        console.warn("Firestore persistence can only be enabled in one tab at a time.");
                    } else {
                        console.error("Firebase initialization error:", e);
                        showConfigPrompt("La configuración de Firebase es inválida.");
                    }
                    // Still return true if it's just a multi-tab issue
                    return db != null;
                }
            } else {
                showConfigPrompt("Aplicación no configurada. Un admin debe iniciar sesión.");
                return false;
            }
        }
        
        function showConfigPrompt(message) {
            const prompt = document.getElementById('config-prompt');
            prompt.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ${message}`;
            prompt.classList.remove('hidden');
        }

        initializeFirebase().then(initialized => {
            if (initialized) {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userDoc = await getDoc(doc(db, "users", user.uid));
                        if (userDoc.exists()) {
                            currentUserRole = userDoc.data().role;
                            initializeAppUI(currentUserRole);
                        } else { // New user registration
                            let roleToAssign = 'jardineria', message, messageType = 'success';
                            if (user.email.toLowerCase() === ADMIN_EMAIL) {
                                const adminSnapshot = await getDocs(query(collection(db, "users"), where("role", "==", "administrador_condominio")));
                                roleToAssign = adminSnapshot.empty ? 'administrador_condominio' : 'jardineria';
                                message = adminSnapshot.empty ? '¡Cuenta de Administrador creada!' : 'Un admin ya existe. Rol por defecto asignado.';
                                if (!adminSnapshot.empty) messageType = 'warning';
                            } else {
                                message = 'Rol por defecto asignado.';
                                messageType = 'warning';
                            }

                            try {
                                await setDoc(doc(db, "users", user.uid), { email: user.email, role: roleToAssign, createdAt: serverTimestamp() });
                                showAlert(message, messageType);
                                currentUserRole = roleToAssign;
                                initializeAppUI(currentUserRole);
                            } catch (error) {
                                console.error("Error creating user document in Firestore:", error);
                                showAlert("Error crítico: No se pudo crear el perfil de usuario. Revisa las reglas de seguridad de Firestore.", "error");
                                signOut(auth);
                            }
                        }
                    } else {
                        currentUserRole = null;
                        loginScreen.classList.remove('hidden');
                        appWrapper.classList.add('hidden');
                        unsubscribeListeners.forEach(unsub => unsub());
                        unsubscribeListeners = [];
                        
                        if (sessionStorage.getItem('justConfigured') === 'true') {
                            sessionStorage.removeItem('justConfigured');
                            showAlert('¡Configuración guardada! Ahora registra la cuenta del administrador.', 'success');
                            toggleAuthForms('register');
                            const registerEmailInput = document.getElementById('register-email');
                            if (registerEmailInput) {
                                registerEmailInput.value = ADMIN_EMAIL;
                                registerEmailInput.readOnly = true;
                            }
                            document.getElementById('auth-subtitle').textContent = 'Completa el registro para finalizar la configuración.';
                        }
                    }
                });
            }
        });

        document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); handleAuth(signInWithEmailAndPassword, 'login-email', 'login-password'); });
        document.getElementById('register-form').addEventListener('submit', e => { e.preventDefault(); handleAuth(createUserWithEmailAndPassword, 'register-email', 'register-password'); });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        async function handleAuth(authFunc, emailId, passId) {
            const email = document.getElementById(emailId).value;
            const password = document.getElementById(passId).value;
            const errorP = document.getElementById('auth-error');
            try {
                errorP.classList.add('hidden');
                await authFunc(auth, email, password);
            } catch (error) {
                if (email.toLowerCase() === ADMIN_EMAIL && !localStorage.getItem('firebaseConfig')) {
                    initializeAppUI('administrador_condominio', true);
                    showAlert('Inicia sesión para configurar la aplicación.', 'warning');
                } else {
                    errorP.textContent = "Error: " + error.code.replace('auth/', '').replace(/-/g, ' ');
                    errorP.classList.remove('hidden');
                }
            }
        }
        
        const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form');
        const loginPrompt = document.getElementById('login-prompt'), registerPrompt = document.getElementById('register-prompt');
        const authTitle = document.getElementById('auth-title'), authSubtitle = document.getElementById('auth-subtitle');
        document.getElementById('show-register').addEventListener('click', e => { e.preventDefault(); toggleAuthForms('register'); });
        document.getElementById('show-login').addEventListener('click', e => { e.preventDefault(); toggleAuthForms('login'); });
        function toggleAuthForms(mode) {
            const isRegister = mode === 'register';
            loginForm.classList.toggle('hidden', isRegister); registerForm.classList.toggle('hidden', !isRegister);
            loginPrompt.classList.toggle('hidden', isRegister); registerPrompt.classList.toggle('hidden', !isRegister);
            authTitle.textContent = isRegister ? 'Crear Cuenta' : 'Bienvenido';
            authSubtitle.textContent = isRegister ? 'Únete a la plataforma para empezar.' : 'Ingresa tus credenciales para continuar.';
            const registerEmailInput = document.getElementById('register-email');
            if(registerEmailInput) registerEmailInput.readOnly = false; // Reset readOnly state
        }

        const permissions = {
            administrador_condominio: ['admin', 'dashboard', 'mantencion', 'tareas', 'jardineria', 'inventario', 'proveedores', 'directorio'],
            comite: ['dashboard', 'mantencion', 'tareas', 'jardineria', 'inventario', 'proveedores', 'directorio'],
            mayordomo: ['tareas', 'jardineria', 'inventario', 'directorio'],
            jardineria: ['jardineria']
        };
        const roleNames = { administrador_condominio: 'Admin', comite: 'Comité', mayordomo: 'Mayordomo', jardineria: 'Jardinería' };
        
        function initializeAppUI(role, isPreConfig = false) {
            loginScreen.classList.add('hidden');
            appWrapper.classList.remove('hidden');
            const userEmail = auth?.currentUser?.email || ADMIN_EMAIL;
            document.getElementById('userIdDisplay').textContent = `${roleNames[role]} (${userEmail.split('@')[0]})`;
            
            document.querySelectorAll('.nav-link').forEach(link => {
                const module = link.dataset.module;
                const isAllowed = isPreConfig ? module === 'admin' : permissions[role]?.includes(module);
                link.style.display = isAllowed ? 'flex' : 'none';
            });

            const firstLink = isPreConfig ? '#admin' : document.querySelector('.nav-link[style*="display: flex"]')?.getAttribute('href');
            if (firstLink) window.location.hash = firstLink;
            
            navigate();
            loadAllModulesContent(role);
            initializeAppListeners(role, isPreConfig);
        }

        // --- DYNAMIC CONTENT & LISTENERS ---
        function loadAllModulesContent(role) {
            const allowed = permissions[role] || [];
            const load = (id, templateFn) => { if(allowed.includes(id) && document.getElementById(id)) document.getElementById(id).innerHTML = templateFn(); };
            load('dashboard', getDashboardTemplate);
            load('mantencion', () => getGenericListTemplate('Mantenciones', 'mantencion', 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'));
            load('tareas', getTareasTemplate);
            load('jardineria', getJardineriaTemplate);
            load('inventario', () => getGenericListTemplate('Inventario', 'inventario', 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6'));
            load('proveedores', () => getGenericListTemplate('Proveedores', 'proveedores', 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'));
            load('directorio', () => getGenericListTemplate('Directorio', 'directorio', 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'));
            load('admin', getAdminTemplate);
            
            const modalContainer = document.getElementById('genericModalContainer');
            if (modalContainer) modalContainer.innerHTML = [
                createModal('mantencion', 'Mantención', {lugar:'text', tipo:'select:Planificada,Urgente', descripcion:'textarea', fecha_inicio:'date', fecha_fin:'date', costo:'number'}),
                createModal('inventario', 'Artículo de Inventario', {nombre:'text', categoria:'text', stock:'number', stock_minimo:'number'}),
                createModal('proveedores', 'Proveedor', {nombre:'text', rubro:'text', contacto:'text', telefono:'tel', email:'email'}),
                createModal('directorio', 'Contacto', {nombre:'text', cargo:'text', telefono:'tel', email:'email'}),
                createModal('tarea', 'Nueva Tarea', {titulo:'text', descripcion:'textarea', asignado:'select:Administración,Mayordomo,Conserjería,Limpieza,Jardinería', fecha_limite:'date', prioridad:'select:Baja,Media,Alta'}),
            ].join('');
        }

        function initializeAppListeners(role, isPreConfig = false) {
            if (isPreConfig || !db) {
                if (role === 'administrador_condominio') setupAdminListeners();
                return;
            }

            document.getElementById('current-date').textContent = new Date().toLocaleString('es-ES', { dateStyle: 'full' });
            const allowed = permissions[role] || [];
            if (allowed.includes('admin')) setupAdminListeners();
            if (allowed.includes('dashboard')) setupDashboardListeners();
            if (allowed.includes('mantencion')) setupGenericListeners('mantencion', 'mantenciones', createSimpleCard);
            if (allowed.includes('tareas')) setupTareasListeners();
            if (allowed.includes('jardineria')) setupJardineriaListeners(role);
            if (allowed.includes('inventario')) setupGenericListeners('inventario', 'inventario', createInventarioCard);
            if (allowed.includes('proveedores')) setupGenericListeners('proveedores', 'proveedores', createSimpleCard);
            if (allowed.includes('directorio')) setupGenericListeners('directorio', 'directorio', createSimpleCard);
            
            document.getElementById('theme-toggle').addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
            window.addEventListener('load', () => {
                applyTheme(localStorage.getItem('theme') || 'light');
                navigate();
            });
            window.addEventListener('hashchange', navigate);
        }

        // TEMPLATES (HTML generation)
        function getDashboardTemplate() { return `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 space-y-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="card p-6 bg-gradient-to-br from-red-500 to-orange-500 text-white shadow-lg"><p class="font-semibold">Mantenciones Urgentes</p><p id="dashboard-urgent-count" class="text-4xl font-extrabold mt-2">0</p></div><div class="card p-6 text-center"><p class="font-semibold">Tareas Pendientes</p><p id="dashboard-tasks-count" class="text-4xl font-extrabold mt-2">0</p></div><div class="card p-6 text-center"><p class="font-semibold">Bajo Stock</p><p id="dashboard-low-stock-count" class="text-4xl font-extrabold mt-2">0</p></div></div><div class="card p-6"><h3 class="font-semibold text-lg mb-4">Mantenciones por Tipo</h3><div class="h-80"><canvas id="maintenanceChart"></canvas></div></div></div><div class="space-y-6"><div class="card p-6"><h3 class="font-semibold text-lg mb-4">Tareas por Estado</h3><div class="h-48"><canvas id="tasksChart"></canvas></div></div><div class="card p-6"><h3 class="font-semibold text-lg mb-4">Próximas Tareas</h3><div id="upcoming-tasks-list" class="space-y-3"></div></div></div></div>`; }
        function getTareasTemplate() { return `<div class="flex justify-end mb-6"><button onclick="showModal('tareaModal')" class="btn-primary py-2 px-4"><i class="fas fa-plus mr-2"></i>Nueva Tarea</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><h3 class="font-semibold text-lg mb-3 pb-2 border-b-2 border-pink-400">Por Hacer</h3><div id="tasks-todo" class="space-y-4 min-h-[200px]"></div></div><div><h3 class="font-semibold text-lg mb-3 pb-2 border-b-2 border-yellow-400">En Progreso</h3><div id="tasks-inprogress" class="space-y-4 min-h-[200px]"></div></div><div><h3 class="font-semibold text-lg mb-3 pb-2 border-b-2 border-green-400">Completado</h3><div id="tasks-completed" class="space-y-4 min-h-[200px]"></div></div></div>`; }
        function getGenericListTemplate(title, id, listClass) { return `<div class="flex justify-end mb-6"><button onclick="showModal('${id}Modal')" class="btn-primary py-2 px-4"><i class="fas fa-plus mr-2"></i>Añadir</button></div><div id="${id}-list" class="${listClass}"></div>`; }
        function getAdminTemplate() { return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="card p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Gestión de Usuarios</h3><button onclick="showModal('user-modal')" class="btn-primary py-2 px-4"><i class="fas fa-user-plus mr-2"></i>Crear Usuario</button></div><div id="user-list" class="space-y-3"></div></div><div class="card p-6"><h3 class="text-xl font-bold mb-4">Configuración de Conexión</h3><form id="firebase-config-form"><p class="text-sm mb-2 text-slate-600 dark:text-slate-300">Pega aquí el objeto de configuración de tu proyecto de Firebase.</p><textarea id="firebase-config-input" rows="10" class="form-input w-full font-mono text-xs" placeholder="{\n  apiKey: '...',\n  authDomain: '...',\n  ...\n}"></textarea><div class="flex justify-end mt-4"><button type="submit" class="btn-primary py-2 px-4">Guardar y Recargar</button></div></form></div></div>`; }
        function getJardineriaTemplate() { 
            return `<div class="card p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <p class="text-sm text-slate-600 dark:text-slate-300">Utilice las herramientas del mapa para dibujar y gestionar las zonas de trabajo.</p>
                </div>
                <div class="relative">
                    <div id="leaflet-map" class="rounded-2xl shadow-inner"></div>
                    <div id="map-legend" class="absolute bottom-4 left-4 card !rounded-xl p-3 text-xs space-y-2 z-[1000]"><h4 class="font-bold text-sm mb-1">Leyenda</h4><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-red-500 border border-white/50"></div><span>Pendiente</span></div><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-green-500 border border-white/50"></div><span>Realizado (0-7d)</span></div><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-yellow-400 border border-white/50"></div><span>Realizado (8-14d)</span></div><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-orange-400 border border-white/50"></div><span>Realizado (15-30d)</span></div><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full" style="background-color: #A52A2A;"></div><span>Realizado (>30d)</span></div></div>
                </div>
            </div>`; 
        }
        
        // GENERIC LISTENERS & RENDERERS
        function setupGenericListeners(id, collectionName, cardRenderer) {
            const unsub = onSnapshot(collection(db, collectionName), (snapshot) => {
                const listEl = document.getElementById(`${id}-list`);
                if (!listEl) return;
                listEl.innerHTML = snapshot.empty ? `<p class="text-center col-span-full text-slate-500">No hay items.</p>` : snapshot.docs.map(doc => cardRenderer({id: doc.id, ...doc.data()})).join('');
            });
            unsubscribeListeners.push(unsub);
            document.getElementById(`${id}ModalForm`)?.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                data.createdAt = serverTimestamp();
                await addDoc(collection(db, collectionName), data);
                hideModal(`${id}Modal`);
                showAlert(`${id.charAt(0).toUpperCase() + id.slice(1)} añadido.`);
            });
        }
        function createSimpleCard(item) { return `<div class="card p-4"> ${Object.entries(item).filter(([k]) => k!=='id' && k!=='createdAt').map(([key, value]) => `<p><strong class="font-semibold capitalize">${key.replace('_',' ')}:</strong> ${value}</p>`).join('')} </div>`; }
        function createInventarioCard(item) {
            const stockLevel = (item.stock / item.stock_minimo) * 100;
            const bgColor = stockLevel < 25 ? 'bg-red-200 dark:bg-red-800/50' : stockLevel < 75 ? 'bg-yellow-200 dark:bg-yellow-800/50' : 'bg-green-200 dark:bg-green-800/50';
            return `<div class="card p-4"><h4 class="font-bold text-lg">${item.nombre}</h4><p class="text-sm text-slate-500">${item.categoria}</p><div class="flex justify-between items-baseline mt-2"><span class="text-2xl font-bold">${item.stock}</span><span class="text-xs">Mín: ${item.stock_minimo}</span></div><div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mt-2"><div class="${bgColor} h-2.5 rounded-full" style="width: ${Math.min(stockLevel, 100)}%"></div></div></div>`;
        }

        // SPECIFIC MODULE LISTENERS
        function setupAdminListeners() {
            const userList = document.getElementById('user-list');
            if (db) {
                const unsub = onSnapshot(collection(db, "users"), (snapshot) => {
                    if(!userList) return;
                    userList.innerHTML = snapshot.docs.map(doc => {
                        const user = doc.data();
                        const isCurrentUser = auth.currentUser && auth.currentUser.uid === doc.id;
                        const deleteButton = isCurrentUser ? '' : `<button class="text-red-500 hover:text-red-700 p-1" onclick="window.deleteUser('${doc.id}')"><i class="fas fa-trash-alt"></i></button>`;
                        return `<div class="flex justify-between items-center p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"><span>${user.email} <span class="text-xs font-semibold bg-indigo-200 dark:bg-indigo-800 p-1 rounded">${roleNames[user.role]}</span></span>${deleteButton}</div>`;
                    }).join('');
                });
                unsubscribeListeners.push(unsub);
            }
            
            window.deleteUser = (userId) => {
                 showConfirmationModal('¿Seguro que quieres eliminar este usuario?', async () => {
                    await deleteDoc(doc(db, "users", userId));
                    showAlert('Usuario eliminado de la base de datos (el acceso puede persistir).');
                 });
            };

            document.getElementById('firebase-config-form')?.addEventListener('submit', e => {
                e.preventDefault();
                const configInput = document.getElementById('firebase-config-input');
                let configString = configInput.value.trim();
                try {
                    const cleanedString = configString.replace(/\u00A0/g, ' ');
                    const jsonString = cleanedString.replace(/([{,]\s*)(\w+)\s*:/g, '$1"$2":');
                    const parsed = JSON.parse(jsonString);
                    if (!parsed.apiKey || !parsed.authDomain) throw new Error("Missing key properties");
                    localStorage.setItem('firebaseConfig', jsonString);
                    sessionStorage.setItem('justConfigured', 'true');
                    showAlert('Configuración guardada. La página se recargará.');
                    setTimeout(() => window.location.reload(), 1500);
                } catch (error) {
                    console.error("Firebase config parsing error:", error);
                    showAlert('Error: El formato de la configuración no es válido.', 'error');
                }
            });

            document.getElementById('user-form')?.addEventListener('submit', async e => {
                e.preventDefault();
                const email = document.getElementById('user-email').value;
                const password = document.getElementById('user-password').value;
                const role = document.getElementById('user-role').value;
                const errorP = document.getElementById('user-form-error');
                errorP.classList.add('hidden');

                try {
                    const tempAuth = getAuth(tempApp);
                    const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
                    const newUserId = userCredential.user.uid;
                    
                    await setDoc(doc(db, "users", newUserId), {
                        email: email,
                        role: role,
                        createdAt: serverTimestamp()
                    });
                    
                    await signOut(tempAuth);
                    
                    showAlert(`Usuario ${email} creado exitosamente.`);
                    hideModal('user-modal');
                    e.target.reset();
                } catch (error) {
                    console.error("Error creating user:", error);
                    errorP.textContent = error.code.replace('auth/', '').replace(/-/g, ' ');
                    errorP.classList.remove('hidden');
                }
            });
        }

        function setupDashboardListeners() {
            const unsubTasks = onSnapshot(collection(db, "tareas"), (snapshot) => {
                const tasks = snapshot.docs.map(d => d.data());
                const pending = tasks.filter(t => t.status !== 'completed').length;
                document.getElementById('dashboard-tasks-count').textContent = pending;
                
                const upcoming = tasks.filter(t => t.status !== 'completed' && t.fecha_limite).sort((a,b) => new Date(a.fecha_limite) - new Date(b.fecha_limite)).slice(0, 3);
                document.getElementById('upcoming-tasks-list').innerHTML = upcoming.length > 0 ? upcoming.map(t => `<div class="text-sm"><strong>${t.titulo}</strong><p class="text-xs text-slate-500">${t.fecha_limite}</p></div>`).join('') : '<p class="text-sm text-center text-slate-500">No hay tareas próximas.</p>';

                if(tasksChart) tasksChart.destroy();
                tasksChart = new Chart(document.getElementById('tasksChart').getContext('2d'), { type: 'doughnut', data: { labels: ['Por Hacer', 'En Progreso', 'Completado'], datasets: [{ data: [tasks.filter(t=>t.status==='todo').length, tasks.filter(t=>t.status==='in-progress').length, tasks.filter(t=>t.status==='completed').length], backgroundColor: ['#fb7185', '#facc15', '#4ade80'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            });
            const unsubInv = onSnapshot(collection(db, "inventario"), snapshot => {
                const lowStock = snapshot.docs.filter(d => d.data().stock < d.data().stock_minimo).length;
                document.getElementById('dashboard-low-stock-count').textContent = lowStock;
            });
            const unsubMaint = onSnapshot(collection(db, "mantenciones"), snapshot => {
                const items = snapshot.docs.map(d => d.data());
                document.getElementById('dashboard-urgent-count').textContent = items.filter(i => i.tipo === 'urgente').length;
                if(maintenanceChart) maintenanceChart.destroy();
                maintenanceChart = new Chart(document.getElementById('maintenanceChart').getContext('2d'), { type: 'bar', data: { labels: ['Planificadas', 'Urgentes'], datasets: [{ label: 'Mantenciones', data: [items.filter(i=>i.tipo === 'planificada').length, items.filter(i=>i.tipo === 'urgente').length], backgroundColor: ['#818cf8', '#f472b6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            });
            unsubscribeListeners.push(unsubTasks, unsubInv, unsubMaint);
        }
        
        function setupTareasListeners() {
            const unsub = onSnapshot(collection(db, "tareas"), (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                document.getElementById('tasks-todo').innerHTML = tasks.filter(t => t.status === 'todo' || !t.status).map(createTaskCard).join('') || '<p class="text-center text-slate-500">Nada por aquí.</p>';
                document.getElementById('tasks-inprogress').innerHTML = tasks.filter(t => t.status === 'in-progress').map(createTaskCard).join('') || '<p class="text-center text-slate-500">Nada por aquí.</p>';
                document.getElementById('tasks-completed').innerHTML = tasks.filter(t => t.status === 'completed').map(createTaskCard).join('') || '<p class="text-center text-slate-500">Nada por aquí.</p>';
            });
            unsubscribeListeners.push(unsub);
            
            document.getElementById('tareaModalForm')?.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                data.createdAt = serverTimestamp();
                data.status = 'todo';
                await addDoc(collection(db, "tareas"), data);
                hideModal('tareaModal');
                showAlert('Tarea creada.');
            });
        }
        function createTaskCard(task) {
            const priorityColors = { baja: 'bg-blue-200 text-blue-800', media: 'bg-yellow-200 text-yellow-800', alta: 'bg-red-200 text-red-800' };
            return `<div class="card p-4"><div class="flex justify-between items-start"><div><h4 class="font-bold">${task.titulo}</h4><p class="text-xs text-slate-500">${task.asignado}</p></div><span class="text-xs font-bold px-2 py-1 rounded-full ${priorityColors[task.prioridad]}">${task.prioridad}</span></div><p class="text-sm mt-2">${task.descripcion}</p><p class="text-xs text-right mt-2 font-semibold">${task.fecha_limite}</p><div class="mt-2 pt-2 border-t flex gap-2 justify-end">${task.status !== 'todo' ? `<button onclick="window.updateTaskStatus('${task.id}', 'todo')" class="text-xs p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded">Por Hacer</button>`:''}${task.status !== 'in-progress' ? `<button onclick="window.updateTaskStatus('${task.id}', 'in-progress')" class="text-xs p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded">En Progreso</button>`:''}${task.status !== 'completed' ? `<button onclick="window.updateTaskStatus('${task.id}', 'completed')" class="text-xs p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded">Completar</button>`:''}</div></div>`;
        }
        window.updateTaskStatus = (id, status) => updateDoc(doc(db, 'tareas', id), { status });


        function setupJardineriaListeners(role) {
            const canManage = role === 'administrador_condominio' || role === 'comite';
            const mapElement = document.getElementById('leaflet-map');
            if (!mapElement) return;

            const fixedLatitude = -33.5982;
            const fixedLongitude = -70.5785;
            
            mapElement.innerHTML = '';
            let map = L.map('leaflet-map').setView([fixedLatitude, fixedLongitude], 18);
            let drawnItems = new L.FeatureGroup().addTo(map);

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });
            const googleSatellite = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
                maxZoom: 20,
                subdomains:['mt0','mt1','mt2','mt3'],
                attribution: 'Map data &copy; Google'
            });
            
            googleSatellite.addTo(map); // Default to Google Satellite

            if (canManage) {
                let drawControl = new L.Control.Draw({
                    draw: { polygon: true, marker: false, circle: false, polyline: false, rectangle: false, circlemarker: false },
                    edit: { featureGroup: drawnItems }
                });
                map.addControl(drawControl);

                map.on(L.Draw.Event.CREATED, function (event) {
                    const layer = event.layer;
                    const geoJSON = layer.toGeoJSON();
                    showConfirmationModal('¿Guardar esta nueva zona?', async () => {
                        await addDoc(collection(db, 'gardening_zones'), {
                            geoJSON: geoJSON,
                            status: 'pending',
                            lastUpdated: serverTimestamp()
                        });
                        showAlert('Zona guardada.');
                    });
                });
            }

            const unsubZones = onSnapshot(collection(db, 'gardening_zones'), snapshot => {
                drawnItems.clearLayers();
                snapshot.forEach(docSnap => {
                    const zone = { id: docSnap.id, ...docSnap.data() };
                    const layer = L.geoJSON(zone.geoJSON, {
                        style: {
                            fillColor: getZoneColor(zone),
                            weight: 2,
                            opacity: 1,
                            color: 'white',
                            fillOpacity: 0.7
                        }
                    }).addTo(drawnItems);
                    
                    layer.on('click', () => {
                        if(canManage) {
                            showConfirmationModal('¿Estás seguro de que quieres eliminar esta zona?', () => {
                                deleteDoc(doc(db, 'gardening_zones', zone.id));
                                showAlert('Zona eliminada.');
                            });
                        } else {
                            updateDoc(doc(db, 'gardening_zones', zone.id), {
                                status: 'done',
                                lastUpdated: serverTimestamp()
                            });
                        }
                    });
                });
            });
            unsubscribeListeners.push(unsubZones);
            
            setTimeout(() => map.invalidateSize(), 500);
        }

        function getZoneColor(zone) {
            if (zone.status === 'pending') return '#ef4444'; // red-500
            const lastUpdated = zone.lastUpdated.toDate();
            const daysDiff = (new Date() - lastUpdated) / 86400000;
            if (daysDiff <= 7) return '#22c55e';   // green-500
            if (daysDiff <= 14) return '#facc15';  // yellow-400
            if (daysDiff <= 30) return '#fb923c';  // orange-400
            return '#A52A2A'; // Brown
        }

        // --- GENERAL HELPERS ---
        function createModal(id, title, fields) {
            const fieldHtml = Object.entries(fields).map(([key, type]) => {
                const parts = type.split(':');
                const inputType = parts[0];
                const options = parts[1] ? parts[1].split(',') : [];
                let field = '';
                if (inputType === 'textarea') {
                    field = `<textarea name="${key}" rows="3" class="form-input w-full"></textarea>`;
                } else if (inputType === 'select') {
                    field = `<select name="${key}" class="form-input w-full">${options.map(o => `<option value="${o.toLowerCase().replace(' ','_')}">${o}</option>`).join('')}</select>`;
                } else {
                    field = `<input type="${inputType}" name="${key}" class="form-input w-full">`;
                }
                return `<div><label class="block text-sm font-medium capitalize">${key.replace(/_/g, ' ')}</label>${field}</div>`;
            }).join('');
            return `<div id="${id}Modal" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden"><div class="card w-11/12 md:w-1/3 p-6"><h3 class="text-xl font-semibold mb-4">${title}</h3><form id="${id}ModalForm" class="space-y-4">${fieldHtml}<div class="flex justify-end gap-4 mt-4"><button type="button" onclick="hideModal('${id}Modal')" class="bg-gray-200 dark:bg-gray-600 p-2 rounded-lg">Cancelar</button><button type="submit" class="btn-primary py-2 px-4">Guardar</button></div></form></div></div>`;
        }
        window.showModal = (id) => document.getElementById(id)?.classList.remove('hidden');
        window.hideModal = (id) => document.getElementById(id)?.classList.add('hidden');
        
        function showConfirmationModal(message, onConfirmCallback) {
            document.getElementById('confirmation-message').textContent = message;
            const confirmBtn = document.getElementById('confirm-action-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => {
                onConfirmCallback();
                hideModal('confirmationModal');
            });
            document.getElementById('cancel-confirmation-btn').onclick = () => hideModal('confirmationModal');
            showModal('confirmationModal');
        }
        function showAlert(message, type = 'success') {
            const alertBox = document.getElementById('custom-alert');
            alertBox.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 ${type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-green-500'}`;
            document.getElementById('custom-alert-message').textContent = message;
            alertBox.classList.remove('hidden');
            setTimeout(() => alertBox.classList.add('hidden'), 4000);
        }
        function navigate() {
            let hash = window.location.hash || '#dashboard';
            const firstAllowedPage = document.querySelector('.nav-link[style*="display: flex"]')?.getAttribute('href');
            if (document.querySelector(`.nav-link[href="${hash}"]`)?.style.display === 'none') {
                hash = firstAllowedPage || '#dashboard';
                window.location.hash = hash;
            }
            document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', `#${p.id}` === hash));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.getAttribute('href') === hash));
            document.getElementById('page-title').textContent = document.querySelector(`.nav-link.active span`)?.textContent || 'Dashboard';
            
            const sidebar = document.getElementById('sidebar');
            document.getElementById('open-sidebar-btn').onclick = () => sidebar.classList.toggle('-translate-x-full');
        }
        function applyTheme(theme) {
            const isDark = theme === 'dark';
            document.documentElement.classList.toggle('dark', isDark);
            const themeToggle = document.getElementById('theme-toggle');
            if(themeToggle) themeToggle.innerHTML = isDark ? '<i class="fas fa-sun text-xl"></i><span>Modo Claro</span>' : '<i class="fas fa-moon text-xl"></i><span>Modo Oscuro</span>';
        }
    </script>
</body>
</html>




