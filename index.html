<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComitéActivo: Gestión para Edificios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <style>
        :root {
            --bg-light: #f3e8ff; --bg-dark: #1e1b4b;
            --sidebar-light: #1e1b4b; --sidebar-dark: #0c0a1d;
            --card-light-bg: rgba(255, 255, 255, 0.8);
            --card-dark-bg: rgba(55, 48, 163, 0.5);
            --text-light: #1e1b4b; --text-dark: #e0e7ff;
            --text-muted-light: #4c1d95; --text-muted-dark: #a5b4fc;
            --border-light: rgba(226, 232, 240, 0.9);
            --border-dark: rgba(129, 140, 248, 0.3);
            --primary: #6d28d9; --primary-hover: #5b21b6;
        }
        html.dark { color-scheme: dark; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9;
            color: var(--text-light);
            overflow: hidden;
        }
        html.dark body { 
            background-color: #0f172a;
            color: var(--text-dark); 
        }
        #app-wrapper {
            background-color: var(--bg-light);
            background-image: linear-gradient(135deg, #f3e8ff 0%, #e0e7ff 100%);
        }
        html.dark #app-wrapper {
            background-color: var(--bg-dark); 
            background-image: linear-gradient(135deg, #1e1b4b 0%, #0c0a1d 100%);
        }
        .sidebar { transition: transform 0.3s ease-in-out; background-color: var(--sidebar-light); }
        html.dark .sidebar { background-color: var(--sidebar-dark); }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .modal-backdrop { background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(8px); z-index: 40; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        .card { 
            background-color: var(--card-light-bg); 
            border: 1px solid var(--border-light); 
            backdrop-filter: blur(12px);
            border-radius: 1.5rem; 
        }
        html.dark .card { 
            background-color: var(--card-dark-bg); 
            border-color: var(--border-dark); 
        }
        .sidebar .nav-link { color: #c7d2fe; font-weight: 500; }
        .sidebar .nav-link:hover { background-color: rgba(79, 70, 229, 0.5); color: #ffffff; }
        .sidebar .nav-link.active { 
            color: #ffffff;
            background-color: #4f46e5;
            font-weight: 700;
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39);
        }
        .btn-primary {
            background-color: var(--primary); color: white; transition: all 0.3s ease; border-radius: 0.75rem;
            box-shadow: 0 4px 15px -5px rgba(109, 40, 217, 0.6);
        }
        .btn-primary:hover { 
            background-color: var(--primary-hover); transform: translateY(-2px); 
            box-shadow: 0 6px 20px -5px rgba(109, 40, 217, 0.8);
        }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; transform: none; box-shadow: none;}
        .form-input {
            background-color: #f8fafc !important; color: #0f172a !important; border: 1px solid #e2e8f0;
            border-radius: 0.75rem; transition: all 0.3s ease;
        }
        .form-input:focus {
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.2);
        }
        html.dark .form-input {
            background-color: #1e293b !important; color: #e2e8f0 !important; border-color: #334155;
        }
        html.dark .form-input:focus { box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.3); }
        #map-container { width: 100%; height: 75vh; cursor: crosshair; background-color: #e0e7ff; }
        html.dark #map-container { background-color: #312e81; }
        #map-image { touch-action: none; transform-origin: 0 0; }
        .marker { position: absolute; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4); transform: translate(-50%, -50%); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .marker:hover { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800">
    <!-- Login Screen -->
    <div id="login-screen" class="h-screen w-screen flex items-center justify-center">
        <div class="w-full h-full flex items-center justify-center shadow-2xl">
            <!-- Left Panel -->
            <div class="hidden lg:flex w-1/2 h-full bg-indigo-700 items-center justify-center relative overflow-hidden">
                <div class="absolute w-60 h-60 rounded-xl bg-indigo-800 -top-5 -left-16 transform rotate-45 opacity-50"></div>
                <div class="absolute w-72 h-72 rounded-full bg-indigo-600 -bottom-24 -right-8 opacity-50"></div>
                <div class="z-10 text-white text-center p-12">
                    <svg class="h-20 w-20 mx-auto mb-6 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 20V10H10V20H14Z" fill="currentColor" opacity="0.7"/><path d="M20 20V4H16V20H20Z" fill="currentColor"/><path d="M4 20V14H8V20H4Z" fill="currentColor" opacity="0.7"/></svg>
                    <h1 class="text-5xl font-bold mb-3 tracking-tight">ComitéActivo</h1>
                    <p class="text-indigo-200 text-lg">Gestión inteligente para tu comunidad.</p>
                </div>
            </div>
            <!-- Right Panel -->
            <div class="w-full lg:w-1/2 h-full flex items-center justify-center bg-white dark:bg-slate-900">
                <div class="w-full max-w-sm p-8">
                    <h2 id="auth-title" class="text-3xl font-bold text-gray-800 dark:text-white mb-2">Bienvenido</h2>
                    <p id="auth-subtitle" class="text-gray-500 dark:text-gray-400 mb-8">Ingresa tus credenciales para continuar.</p>
                    <form id="login-form" class="space-y-6">
                        <div class="relative"><i class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="email" id="login-email" class="form-input mt-1 block w-full pl-12 p-3.5" placeholder="Email" required></div>
                        <div class="relative"><i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="password" id="login-password" class="form-input mt-1 block w-full pl-12 p-3.5" placeholder="Contraseña" required></div>
                        <p id="auth-error" class="text-red-500 text-sm text-center hidden"></p>
                        <button type="submit" class="btn-primary w-full py-3 font-bold text-lg">Ingresar</button>
                    </form>
                    <form id="register-form" class="space-y-6 hidden">
                        <div class="relative"><i class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="email" id="register-email" class="form-input mt-1 block w-full pl-12 p-3.5" placeholder="Email" required></div>
                        <div class="relative"><i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i><input type="password" id="register-password" class="form-input mt-1 block w-full pl-12 p-3.5" placeholder="Contraseña (mín. 6 caracteres)" required></div>
                        <button type="submit" class="btn-primary w-full py-3 font-bold text-lg">Crear Cuenta</button>
                    </form>
                    <p id="config-prompt" class="text-center mt-4 text-sm text-orange-600 dark:text-orange-400 font-semibold hidden"><i class="fas fa-exclamation-triangle mr-2"></i>La aplicación no está configurada.</p>
                    <p class="text-center mt-6 text-sm text-gray-500 dark:text-gray-400">
                        <span id="login-prompt">¿No tienes una cuenta? <a href="#" id="show-register" class="font-semibold text-indigo-600 hover:underline dark:text-indigo-400">Regístrate</a></span>
                        <span id="register-prompt" class="hidden">¿Ya tienes una cuenta? <a href="#" id="show-login" class="font-semibold text-indigo-600 hover:underline dark:text-indigo-400">Inicia Sesión</a></span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Wrapper -->
    <div id="app-wrapper" class="hidden h-screen">
        <div id="app-container" class="flex h-full overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar w-64 min-h-full p-4 flex-shrink-0 transform -translate-x-full md:translate-x-0 md:relative">
                <div class="flex items-center gap-3 mb-10 px-1">
                    <div class="bg-white/10 p-2 rounded-xl"><svg class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 20V10H10V20H14Z" fill="currentColor" opacity="0.7"/><path d="M20 20V4H16V20H20Z" fill="currentColor"/><path d="M4 20V14H8V20H4Z" fill="currentColor" opacity="0.7"/></svg></div>
                    <div><h1 class="text-xl font-bold text-white">ComitéActivo</h1><p id="userIdDisplay" class="text-xs text-indigo-300">Cargando...</p></div>
                </div>
                <nav>
                    <a href="#dashboard" class="nav-link active flex items-center p-3 rounded-xl" data-module="dashboard"><i class="fas fa-home w-6 text-center"></i><span class="ml-4">Dashboard</span></a>
                    <a href="#mantencion" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="mantencion"><i class="fas fa-tools w-6 text-center"></i><span class="ml-4">Mantención</span></a>
                    <a href="#tareas" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="tareas"><i class="fas fa-tasks w-6 text-center"></i><span class="ml-4">Tareas</span></a>
                    <a href="#jardineria" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="jardineria"><i class="fas fa-seedling w-6 text-center"></i><span class="ml-4">Jardinería</span></a>
                    <a href="#inventario" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="inventario"><i class="fas fa-box-open w-6 text-center"></i><span class="ml-4">Inventario</span></a>
                    <a href="#proveedores" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="proveedores"><i class="fas fa-truck w-6 text-center"></i><span class="ml-4">Proveedores</span></a>
                    <a href="#directorio" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="directorio"><i class="fas fa-address-book w-6 text-center"></i><span class="ml-4">Directorio</span></a>
                    <a href="#admin" class="nav-link mt-2 flex items-center p-3 rounded-xl" data-module="admin"><i class="fas fa-user-shield w-6 text-center"></i><span class="ml-4">Administración</span></a>
                </nav>
                <div class="absolute bottom-4 left-4 right-4">
                     <button id="logout-btn" class="w-full flex items-center justify-center gap-2 p-3 mb-2 rounded-xl text-indigo-200 hover:bg-red-800/50"><i class="fas fa-sign-out-alt text-xl"></i><span>Cerrar Sesión</span></button>
                     <button id="theme-toggle" class="w-full flex items-center justify-center gap-2 p-3 rounded-xl text-indigo-200 hover:bg-indigo-800"><i class="fas fa-moon text-xl"></i><span>Modo Oscuro</span></button>
                </div>
            </aside>

            <!-- Main Content -->
            <div id="main-content" class="main-content flex-1 flex flex-col overflow-hidden">
                <header class="p-6 flex justify-between items-center"><button id="open-sidebar-btn" class="md:hidden text-indigo-900 dark:text-indigo-200"><i class="fas fa-bars text-xl"></i></button><div><h2 id="page-title" class="text-2xl font-bold text-indigo-900 dark:text-white">Dashboard</h2></div><div class="text-right"><p id="current-date" class="font-semibold text-indigo-900 dark:text-white"></p><p class="text-sm text-muted-light dark:text-muted-dark">¡Bienvenido de nuevo!</p></div></header>
                <main class="flex-1 overflow-x-hidden overflow-y-auto p-6 pt-0">
                    <div id="dashboard" class="page active"></div>
                    <div id="mantencion" class="page"></div>
                    <div id="tareas" class="page"></div>
                    <div id="jardineria" class="page"></div>
                    <div id="inventario" class="page"></div>
                    <div id="proveedores" class="page"></div>
                    <div id="directorio" class="page"></div>
                    <div id="admin" class="page"></div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="confirmationModal" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden"><div class="card w-11/12 md:w-1/3 p-6"><h3 class="text-xl font-semibold mb-4">Confirmación Requerida</h3><p id="confirmation-message" class="mb-6"></p><div class="flex justify-end gap-4"><button id="cancel-confirmation-btn" class="bg-gray-200 dark:bg-gray-600 p-2 rounded-lg">Cancelar</button><button id="confirm-action-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button></div></div></div>
    <div id="user-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden"><div class="card w-11/12 md:w-1/3 p-6"><h3 class="text-xl font-semibold mb-4">Invitar Nuevo Usuario</h3><form id="user-form" class="space-y-4"><div><label>Email del invitado</label><input type="email" id="user-email" class="form-input w-full" required></div><div><label>Asignar Rol</label><select id="user-role" class="form-input w-full"><option value="jardineria">Jardinería</option><option value="mayordomo">Mayordomo</option><option value="comite">Comité</option><option value="administrador_condominio">Administrador de Condominio</option></select></div><p id="user-form-error" class="text-red-500 text-sm hidden"></p><div class="flex justify-end gap-4"><button type="button" onclick="hideModal('user-modal')" class="bg-gray-200 dark:bg-gray-600 p-2 rounded-lg">Cancelar</button><button type="submit" class="btn-primary p-2">Enviar Invitación</button></div></form></div></div>
    <div id="custom-alert" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50"><p id="custom-alert-message"></p></div>
    <!-- Generic Modals: Populated by JS -->
    <div id="genericModalContainer"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, deleteDoc, query, where, getDocs, addDoc, updateDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth, currentUserRole = null;
        let panzoomInstance, activeMapId = null;
        let unsubscribeListeners = [];
        let tasksChart, maintenanceChart;
        
        const ADMIN_EMAIL = "admin_gino@comite.cl";
        const loginScreen = document.getElementById('login-screen');
        const appWrapper = document.getElementById('app-wrapper');

        function initializeFirebase() {
            const storedConfig = localStorage.getItem('firebaseConfig');
            if (storedConfig) {
                try {
                    const firebaseConfig = JSON.parse(storedConfig);
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    return true;
                } catch (e) {
                    showConfigPrompt("La configuración de Firebase es inválida.");
                    return false;
                }
            } else {
                showConfigPrompt("Aplicación no configurada. Un admin debe iniciar sesión.");
                return false;
            }
        }
        
        function showConfigPrompt(message) {
            const prompt = document.getElementById('config-prompt');
            prompt.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ${message}`;
            prompt.classList.remove('hidden');
            document.querySelectorAll('#login-form button, #register-form button, #login-form input, #register-form input').forEach(el => el.disabled = true);
        }

        if (initializeFirebase()) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        currentUserRole = userDoc.data().role;
                        initializeAppUI(currentUserRole);
                    } else { // New user registration
                        let roleToAssign = 'jardineria', message, messageType = 'success';
                        if (user.email.toLowerCase() === ADMIN_EMAIL) {
                            const adminSnapshot = await getDocs(query(collection(db, "users"), where("role", "==", "administrador_condominio")));
                            roleToAssign = adminSnapshot.empty ? 'administrador_condominio' : 'jardineria';
                            message = adminSnapshot.empty ? '¡Cuenta de Administrador creada!' : 'Un admin ya existe. Rol por defecto asignado.';
                            if (!adminSnapshot.empty) messageType = 'warning';
                        } else {
                            const inv = await getDoc(doc(db, "invitations", user.email));
                            if (inv.exists()) {
                                roleToAssign = inv.data().role;
                                message = `¡Bienvenido! Se te asignó el rol de ${roleNames[roleToAssign]}.`;
                                await deleteDoc(inv.ref);
                            } else {
                                message = 'No se encontró invitación. Rol por defecto asignado.';
                                messageType = 'warning';
                            }
                        }
                        await setDoc(doc(db, "users", user.uid), { email: user.email, role: roleToAssign, createdAt: serverTimestamp() });
                        showAlert(message, messageType);
                        currentUserRole = roleToAssign;
                        initializeAppUI(currentUserRole);
                    }
                } else {
                    currentUserRole = null;
                    loginScreen.classList.remove('hidden');
                    appWrapper.classList.add('hidden');
                    unsubscribeListeners.forEach(unsub => unsub());
                    unsubscribeListeners = [];
                }
            });
        }

        document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); handleAuth(signInWithEmailAndPassword, 'login-email', 'login-password'); });
        document.getElementById('register-form').addEventListener('submit', e => { e.preventDefault(); handleAuth(createUserWithEmailAndPassword, 'register-email', 'register-password'); });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        async function handleAuth(authFunc, emailId, passId) {
            const email = document.getElementById(emailId).value;
            const password = document.getElementById(passId).value;
            const errorP = document.getElementById('auth-error');
            try {
                errorP.classList.add('hidden');
                await authFunc(auth, email, password);
            } catch (error) {
                if (email.toLowerCase() === ADMIN_EMAIL && !localStorage.getItem('firebaseConfig')) {
                    initializeAppUI('administrador_condominio'); 
                    showAlert('Inicia sesión para configurar la aplicación.', 'warning');
                } else {
                    errorP.textContent = "Error: " + error.code.replace('auth/', '').replace(/-/g, ' ');
                    errorP.classList.remove('hidden');
                }
            }
        }
        
        const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form');
        const loginPrompt = document.getElementById('login-prompt'), registerPrompt = document.getElementById('register-prompt');
        const authTitle = document.getElementById('auth-title'), authSubtitle = document.getElementById('auth-subtitle');
        document.getElementById('show-register').addEventListener('click', e => { e.preventDefault(); toggleAuthForms('register'); });
        document.getElementById('show-login').addEventListener('click', e => { e.preventDefault(); toggleAuthForms('login'); });
        function toggleAuthForms(mode) {
            const isRegister = mode === 'register';
            loginForm.classList.toggle('hidden', isRegister); registerForm.classList.toggle('hidden', !isRegister);
            loginPrompt.classList.toggle('hidden', isRegister); registerPrompt.classList.toggle('hidden', !isRegister);
            authTitle.textContent = isRegister ? 'Crear Cuenta' : 'Bienvenido';
            authSubtitle.textContent = isRegister ? 'Únete a la plataforma para empezar.' : 'Ingresa tus credenciales para continuar.';
        }

        const permissions = {
            administrador_condominio: ['admin', 'dashboard', 'mantencion', 'tareas', 'jardineria', 'inventario', 'proveedores', 'directorio'],
            comite: ['dashboard', 'mantencion', 'tareas', 'jardineria', 'inventario', 'proveedores', 'directorio'],
            mayordomo: ['tareas', 'jardineria', 'inventario', 'directorio'],
            jardineria: ['jardineria']
        };
        const roleNames = { administrador_condominio: 'Admin', comite: 'Comité', mayordomo: 'Mayordomo', jardineria: 'Jardinería' };
        
        function initializeAppUI(role) {
            loginScreen.classList.add('hidden');
            appWrapper.classList.remove('hidden');
            const userEmail = auth?.currentUser?.email || ADMIN_EMAIL;
            document.getElementById('userIdDisplay').textContent = `${roleNames[role]} (${userEmail.split('@')[0]})`;
            document.querySelectorAll('.nav-link').forEach(link => {
                link.style.display = permissions[role]?.includes(link.dataset.module) ? 'flex' : 'none';
            });
            const firstLink = document.querySelector('.nav-link[style*="display: flex"]');
            if (firstLink) window.location.hash = firstLink.getAttribute('href'); else navigate();
            loadAllModulesContent(role);
            initializeAppListeners(role);
        }

        // --- DYNAMIC CONTENT & LISTENERS ---
        function loadAllModulesContent(role) {
            const allowed = permissions[role] || [];
            const load = (id, templateFn) => { if(allowed.includes(id) && document.getElementById(id)) document.getElementById(id).innerHTML = templateFn(); };
            load('dashboard', getDashboardTemplate);
            load('mantencion', () => getGenericListTemplate('Mantenciones', 'mantencion', 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'));
            load('tareas', getTareasTemplate);
            load('jardineria', getJardineriaTemplate);
            load('inventario', () => getGenericListTemplate('Inventario', 'inventario', 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6'));
            load('proveedores', () => getGenericListTemplate('Proveedores', 'proveedores', 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'));
            load('directorio', () => getGenericListTemplate('Directorio', 'directorio', 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'));
            load('admin', getAdminTemplate);
            
            const modalContainer = document.getElementById('genericModalContainer');
            if (modalContainer) modalContainer.innerHTML = [
                createModal('mantencion', 'Mantención', {lugar:'text', tipo:'select:Planificada,Urgente', descripcion:'textarea', fecha_inicio:'date', fecha_fin:'date', costo:'number'}),
                createModal('inventario', 'Artículo de Inventario', {nombre:'text', categoria:'text', stock:'number', stock_minimo:'number'}),
                createModal('proveedores', 'Proveedor', {nombre:'text', rubro:'text', contacto:'text', telefono:'tel', email:'email'}),
                createModal('directorio', 'Contacto', {nombre:'text', cargo:'text', telefono:'tel', email:'email'}),
                createModal('tarea', 'Nueva Tarea', {titulo:'text', descripcion:'textarea', asignado:'select:Administración,Mayordomo,Conserjería,Limpieza,Jardinería', fecha_limite:'date', prioridad:'select:Baja,Media,Alta'}),
            ].join('');
        }

        function initializeAppListeners(role) {
            document.getElementById('current-date').textContent = new Date().toLocaleString('es-ES', { dateStyle: 'full' });
            const allowed = permissions[role] || [];
            if (allowed.includes('admin')) setupAdminListeners();
            if (allowed.includes('dashboard')) setupDashboardListeners();
            if (allowed.includes('mantencion')) setupGenericListeners('mantencion', 'mantenciones', createSimpleCard);
            if (allowed.includes('tareas')) setupTareasListeners();
            if (allowed.includes('jardineria')) setupJardineriaListeners(role);
            if (allowed.includes('inventario')) setupGenericListeners('inventario', 'inventario', createInventarioCard);
            if (allowed.includes('proveedores')) setupGenericListeners('proveedores', 'proveedores', createSimpleCard);
            if (allowed.includes('directorio')) setupGenericListeners('directorio', 'directorio', createSimpleCard);
            
            window.addEventListener('load', () => applyTheme(localStorage.getItem('theme') || 'light'));
            window.addEventListener('hashchange', navigate);
        }

        // TEMPLATES (HTML generation)
        function getDashboardTemplate() { return `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 space-y-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="card p-6 bg-gradient-to-br from-red-500 to-orange-500 text-white shadow-lg"><p class="font-semibold">Mantenciones Urgentes</p><p id="dashboard-urgent-count" class="text-4xl font-extrabold mt-2">0</p></div><div class="card p-6 text-center"><p class="font-semibold">Tareas Pendientes</p><p id="dashboard-tasks-count" class="text-4xl font-extrabold mt-2">0</p></div><div class="card p-6 text-center"><p class="font-semibold">Bajo Stock</p><p id="dashboard-low-stock-count" class="text-4xl font-extrabold mt-2">0</p></div></div><div class="card p-6"><h3 class="font-semibold text-lg mb-4">Mantenciones por Tipo</h3><div class="h-80"><canvas id="maintenanceChart"></canvas></div></div></div><div class="space-y-6"><div class="card p-6"><h3 class="font-semibold text-lg mb-4">Tareas por Estado</h3><div class="h-48"><canvas id="tasksChart"></canvas></div></div><div class="card p-6"><h3 class="font-semibold text-lg mb-4">Próximas Tareas</h3><div id="upcoming-tasks-list" class="space-y-3"></div></div></div></div>`; }
        function getTareasTemplate() { return `<div class="flex justify-end mb-6"><button onclick="showModal('tareaModal')" class="btn-primary py-2 px-4"><i class="fas fa-plus mr-2"></i>Nueva Tarea</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div><h3 class="font-semibold text-lg mb-3 pb-2 border-b-2 border-pink-400">Por Hacer</h3><div id="tasks-todo" class="space-y-4 min-h-[200px]"></div></div><div><h3 class="font-semibold text-lg mb-3 pb-2 border-b-2 border-yellow-400">En Progreso</h3><div id="tasks-inprogress" class="space-y-4 min-h-[200px]"></div></div><div><h3 class="font-semibold text-lg mb-3 pb-2 border-b-2 border-green-400">Completado</h3><div id="tasks-completed" class="space-y-4 min-h-[200px]"></div></div></div>`; }
        function getGenericListTemplate(title, id, listClass) { return `<div class="flex justify-end mb-6"><button onclick="showModal('${id}Modal')" class="btn-primary py-2 px-4"><i class="fas fa-plus mr-2"></i>Añadir</button></div><div id="${id}-list" class="${listClass}"></div>`; }
        function getAdminTemplate() { return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="card p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Gestión de Usuarios</h3><button onclick="showModal('user-modal')" class="btn-primary py-2 px-4"><i class="fas fa-user-plus mr-2"></i>Invitar</button></div><div id="user-list" class="space-y-3"></div></div><div class="card p-6"><h3 class="text-xl font-bold mb-4">Configuración de Conexión</h3><form id="firebase-config-form"><p class="text-sm mb-2 text-slate-600 dark:text-slate-300">Pega aquí el objeto de configuración de tu proyecto de Firebase.</p><textarea id="firebase-config-input" rows="10" class="form-input w-full font-mono text-xs" placeholder="{\n  apiKey: '...',\n  authDomain: '...',\n  ...\n}"></textarea><div class="flex justify-end mt-4"><button type="submit" class="btn-primary py-2 px-4">Guardar y Recargar</button></div></form></div></div>`; }
        function getJardineriaTemplate() { return `<div class="card p-6"><div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><div class="flex items-center gap-3"><label for="map-selector" class="font-semibold">Mapa:</label><select id="map-selector" class="form-input rounded-lg"></select><button id="delete-map-btn" class="text-red-500 hover:text-red-700 hidden p-2"><i class="fas fa-trash-alt"></i></button></div><button id="show-map-modal-btn" class="btn-primary py-2 px-4 hidden"><i class="fas fa-plus mr-2"></i>Cargar Mapa</button></div><div class="relative"><div id="map-container" class="rounded-2xl shadow-inner overflow-hidden relative flex items-center justify-center"><img id="map-image" class="hidden"/><div id="marker-layer"></div><div id="map-placeholder" class="text-center text-slate-500"><i class="fas fa-map-marked-alt text-5xl mb-4"></i><p>Selecciona un mapa para empezar.</p></div></div><div id="map-legend" class="absolute bottom-4 left-4 card !rounded-xl p-3 text-xs space-y-2 hidden"><h4 class="font-bold text-sm mb-1">Leyenda</h4><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-red-500 border border-white/50"></div><span>Pendiente</span></div><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-green-500 border border-white/50"></div><span>Realizado (0-7d)</span></div><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-yellow-400 border border-white/50"></div><span>Realizado (8-14d)</span></div><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full bg-orange-400 border border-white/50"></div><span>Realizado (15-30d)</span></div><div class="flex items-center gap-2"><div class="w-4 h-4 rounded-full" style="background-color: #A52A2A;"></div><span>Realizado (>30d)</span></div></div></div></div>`; }
        
        // GENERIC LISTENERS & RENDERERS
        function setupGenericListeners(id, collectionName, cardRenderer) {
            const unsub = onSnapshot(collection(db, collectionName), (snapshot) => {
                const listEl = document.getElementById(`${id}-list`);
                if (!listEl) return;
                listEl.innerHTML = snapshot.empty ? `<p class="text-center col-span-full text-slate-500">No hay items.</p>` : snapshot.docs.map(doc => cardRenderer({id: doc.id, ...doc.data()})).join('');
            });
            unsubscribeListeners.push(unsub);
            document.getElementById(`${id}ModalForm`)?.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                data.createdAt = serverTimestamp();
                await addDoc(collection(db, collectionName), data);
                hideModal(`${id}Modal`);
                showAlert(`${id.charAt(0).toUpperCase() + id.slice(1)} añadido.`);
            });
        }
        function createSimpleCard(item) { return `<div class="card p-4"> ${Object.entries(item).filter(([k]) => k!=='id' && k!=='createdAt').map(([key, value]) => `<p><strong class="font-semibold capitalize">${key.replace('_',' ')}:</strong> ${value}</p>`).join('')} </div>`; }
        function createInventarioCard(item) {
            const stockLevel = (item.stock / item.stock_minimo) * 100;
            const bgColor = stockLevel < 25 ? 'bg-red-200 dark:bg-red-800/50' : stockLevel < 75 ? 'bg-yellow-200 dark:bg-yellow-800/50' : 'bg-green-200 dark:bg-green-800/50';
            return `<div class="card p-4"><h4 class="font-bold text-lg">${item.nombre}</h4><p class="text-sm text-slate-500">${item.categoria}</p><div class="flex justify-between items-baseline mt-2"><span class="text-2xl font-bold">${item.stock}</span><span class="text-xs">Mín: ${item.stock_minimo}</span></div><div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mt-2"><div class="${bgColor} h-2.5 rounded-full" style="width: ${Math.min(stockLevel, 100)}%"></div></div></div>`;
        }

        // SPECIFIC MODULE LISTENERS
        function setupAdminListeners() { /* ... content from previous version ... */ }
        function setupDashboardListeners() { /* ... */ }
        function setupTareasListeners() { /* ... */ }
        function setupJardineriaListeners(role) { /* ... */ }

        // --- GENERAL HELPERS ---
        function createModal(id, title, fields) {
            const fieldHtml = Object.entries(fields).map(([key, type]) => {
                const parts = type.split(':');
                const inputType = parts[0];
                const options = parts[1] ? parts[1].split(',') : [];
                let field = '';
                if (inputType === 'textarea') {
                    field = `<textarea name="${key}" rows="3" class="form-input w-full"></textarea>`;
                } else if (inputType === 'select') {
                    field = `<select name="${key}" class="form-input w-full">${options.map(o => `<option value="${o.toLowerCase()}">${o}</option>`).join('')}</select>`;
                } else {
                    field = `<input type="${inputType}" name="${key}" class="form-input w-full">`;
                }
                return `<div><label class="block text-sm font-medium capitalize">${key.replace(/_/g, ' ')}</label>${field}</div>`;
            }).join('');
            return `<div id="${id}Modal" class="modal-backdrop fixed inset-0 flex items-center justify-center hidden"><div class="card w-11/12 md:w-1/3 p-6"><h3 class="text-xl font-semibold mb-4">${title}</h3><form id="${id}ModalForm" class="space-y-4">${fieldHtml}<div class="flex justify-end gap-4 mt-4"><button type="button" onclick="hideModal('${id}Modal')" class="bg-gray-200 dark:bg-gray-600 p-2 rounded-lg">Cancelar</button><button type="submit" class="btn-primary py-2 px-4">Guardar</button></div></form></div></div>`;
        }
        window.showModal = (id) => document.getElementById(id)?.classList.remove('hidden');
        window.hideModal = (id) => document.getElementById(id)?.classList.add('hidden');
        function showConfirmationModal(message, onConfirm) { /* ... */ }
        function showAlert(message, type = 'success') { /* ... */ }
        function navigate() { /* ... */ }
        function applyTheme(theme) { /* ... */ }
    </script>
</body>
</html>

